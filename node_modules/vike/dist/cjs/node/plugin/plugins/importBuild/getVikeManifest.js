"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getVikeManifest = void 0;
const utils_js_1 = require("../../utils.js");
const assertPluginManifest_js_1 = require("../../../shared/assertPluginManifest.js");
const extractExportNamesPlugin_js_1 = require("../extractExportNamesPlugin.js");
const path_1 = __importDefault(require("path"));
const globalContext_js_1 = require("../../../runtime/globalContext.js");
function getVikeManifest(config, configVike) {
    const runtimeManifest = (0, globalContext_js_1.getRuntimeManifest)(configVike);
    const manifest = {
        version: utils_js_1.projectInfo.projectVersion,
        usesClientRouter: (0, extractExportNamesPlugin_js_1.isUsingClientRouter)(), // TODO/v1-release: remove
        manifestKeyMap: getManifestKeyMap(configVike, config),
        ...runtimeManifest
    };
    (0, assertPluginManifest_js_1.assertPluginManifest)(manifest);
    return manifest;
}
exports.getVikeManifest = getVikeManifest;
function getManifestKeyMap(configVike, config) {
    const manifestKeyMap = {};
    configVike.extensions
        .map(({ pageConfigsDistFiles }) => pageConfigsDistFiles)
        .flat()
        .filter(utils_js_1.isNotNullish)
        .forEach(({ importPath, filePath }) => {
        // Recreating https://github.com/vitejs/vite/blob/8158ece72b66307e7b607b98496891610ca70ea2/packages/vite/src/node/plugins/manifest.ts#L38
        const filePathRelative = path_1.default.posix.relative(config.root, (0, utils_js_1.toPosixPath)(filePath));
        (0, utils_js_1.assertPosixPath)(filePathRelative);
        (0, utils_js_1.assertPosixPath)(importPath);
        manifestKeyMap[importPath] = filePathRelative;
    });
    return manifestKeyMap;
}
